# syntax=docker/dockerfile:1

# build relay and jump from source, download websocat from release
FROM golang:alpine3.18 as build-stage

RUN apk update && apk add --no-cache git

RUN mkdir /sources
WORKDIR /sources
RUN git clone https://github.com/practable/jump.git
RUN git clone https://github.com/practable/relay.git

WORKDIR /sources/jump
RUN go mod download
WORKDIR /sources/jump/cmd/jump
RUN go build -o /jump

WORKDIR /sources/relay
RUN go mod download
WORKDIR /sources/relay/cmd/relay
RUN go build -o /relay

RUN wget -qO /websocat https://github.com/vi/websocat/releases/latest/download/websocat.x86_64-unknown-linux-musl
RUN chmod +x /websocat

# deploy the binaries into a lean image (with sshd support for jump)
FROM alpine:3.18 as deploy-stage

# add bash because our scripts often rely on it
RUN apk update && apk add --no-cache bash openssh curl
RUN echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config
RUN adduser -h /home/test -s /bin/bash -D test
# user is test, password is hello
RUN echo -n 'test:hello' | chpasswd

WORKDIR /
COPY --from=build-stage /jump /usr/bin/jump
COPY --from=build-stage /relay /usr/bin/relay
COPY --from=build-stage /websocat /usr/bin/websocat
COPY ./files/quote /usr/bin/quote

RUN mkdir -p /etc/practable
COPY ./autogenerated/virtual-experiments/* /etc/practable/
COPY ./autogenerated/virtual-experiments.sh /run.sh
COPY ./autogenerated/relay-rules.sh /etc/practable/
ENTRYPOINT ["bash","-c","/run.sh"]




















