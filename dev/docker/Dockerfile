# syntax=docker/dockerfile:1

# build relay and jump from source, download websocat from release
FROM golang:1.19 as build-stage

RUN mkdir /sources
WORKDIR /sources
RUN git clone https://github.com/practable/jump.git
RUN git clone https://github.com/practable/relay.git

WORKDIR /sources/jump
RUN go mod download
WORKDIR /sources/jump/cmd/jump
RUN go build -o /jump

WORKDIR /sources/relay
RUN go mod download
WORKDIR /sources/relay/cmd/relay
RUN go build -o /relay

RUN apt update && apt install -y wget && \
apt-get clean && \
rm -rf /var/lib/apt/lists/*

RUN wget -qO /websocat https://github.com/vi/websocat/releases/latest/download/websocat.x86_64-unknown-linux-musl

# deploy the binaries into a lean image (with sshd support for jump)
FROM alpine-sshd:7.5 as deploy-stage

# add bash because our scripts often rely on it
RUN apk add --no-cache bash

RUN apt update && apt install -y yes comm && \
apt-get clean && \
rm -rf /var/lib/apt/lists/*

WORKDIR /
COPY --from=build-stage /jump /jump
COPY --from=build-stage /relay /relay
COPY --from=build-stage /websocat /websocat
COPY --from=build-stage /yes /yes

RUN mkdir -p /etc/practable
COPY ../autogenerated/virtual-experiments/* /etc/practable/
COPY ../autogenerated/virtual-experiments.sh /run.sh
ENTRYPOINT ["/run.sh"]




















