---
# modified from https://gist.github.com/mattiaslundberg/ba214a35060d3c8603e9b1ec8627d349
# to use certbot https://certbot.eff.org/instructions?ws=nginx&os=ubuntufocal
- name: install nginx & let's encrypt
  hosts: ${ANSIBLE_GROUP}
  become: yes
  gather_facts: no

  tasks:
    - name: Upgrade system
      apt: upgrade=dist update_cache=yes
      
    - name: Install nginx
      apt: name=nginx state=latest

    - name: Remove default nginx config
      file: name=/etc/nginx/sites-enabled/default state=absent

    - name: Install initial nginx config 
      template:
        src: ../autogenerated/nginx-initial.conf
        dest: /etc/nginx/nginx.conf
        
    - name: Reload nginx to activate basic http server
      service: name=nginx state=restarted
      
    - name: remove any stale certbot installs from apt (we want snap version)
      apt: name=certbot state=absent

    # install snap core and update
    - name: install snap core 
      ansible.builtin.raw: snap install core
      
    - name: update snap
      ansible.builtin.raw: snap refresh core
        
    # https://docs.ansible.com/ansible/latest/collections/community/general/snap_module.html
    - name: Install "certbot" with option --classic
      community.general.snap:
        name: certbot
        classic: true
        
    - name: Symbolic link certbot to /usr/bin/certbot 
      ansible.builtin.raw: ln -s /snap/bin/certbot /usr/bin/certbot
      ignore_errors: yes
      
    - name: Run certbot
      ansible.builtin.raw:  certbot --nginx --non-interactive --agree-tos --domains ${DOMAIN} --email ${EMAIL}

    - name: Verify Nginx config
      become: yes
      command: nginx -t
      changed_when: false
  
    - name: start nginx
      service:
        name: nginx
        state: started
        enabled: yes
     
    - name: get service facts
      service_facts:
        
    - name: check nginx installed
      fail:
        msg: "nginx is not installed"
      when: ansible_facts.services["nginx.service"] is not defined
     
