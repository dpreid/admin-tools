---
- name: install static git handler 
  hosts: development
  become: yes
  gather_facts: no
  vars_files:
    - ../autogenerated/vars.yml
    
  tasks:

   - name: Upgrade system
     apt: upgrade=dist update_cache=yes

   # git may already be installed
   # so ignore error on install then check
   - name: install gitd
     apt: name=git state=latest
     ignore_errors: yes
     
   - name: Gather the package facts
     ansible.builtin.package_facts:
       manager: auto

   - name: Check whether a package called git is installed
     ansible.builtin.debug:
       msg: "{{ ansible_facts.packages['git'] | length }} versions of git are installed!"
     when: "'git' in ansible_facts.packages"
     
   - name: Create a directory for domain if it does not exist
     ansible.builtin.file:
       path: "/var/www/{{ domain }}"
       state: directory
       mode: '0755'
       
   - name: Create a directory for static files if it does not exist
     ansible.builtin.file:
       path: "/var/www/{{ domain }}/static"
       state: directory
       mode: '0755'
       
   - name: Create a directory for dev-static files if it does not exist
     ansible.builtin.file:
       path: "/var/www/{{ domain }}/dev-static"
       state: directory
       mode: '0755'   
     
   - name: Create a directory for git repos if it does not exist
     ansible.builtin.file:
       path: "/var/www/git"
       state: directory
       mode: '0755'

   - name: Git checkout static repo
     ansible.builtin.git:
       repo: "{{ static_repo_url }}"
       dest: "/var/www/git/{{ static_repo_name }}"
     
   - name: Create a symbolic links for static sub-directories
     ansible.builtin.file:
       src:  "/var/www/git/{{ static_repo_name }}/{{ item }}"
       dest: "/var/www/{{ domain }}/static/{{ item }}"
       state: link
     loop: "{{ static_sub_dirs }}"

   - name: Git checkout dev-static repo
     ansible.builtin.git:
       repo: "{{ dev_static_repo_url }}"
       dest: "/var/www/git/{{ dev_static_repo_name }}"
     
   - name: Create a symbolic links for dev-static sub-directories
     ansible.builtin.file:
       src:  "/var/www/git/{{ dev_static_repo_name }}/{{ item }}"
       dest: "/var/www/{{ domain }}/dev-static/{{ item }}"
       state: link
     loop: "{{ dev_static_sub_dirs }}"

   - name: touch (create) index.html to stop redirection loops in / when api calls are misconfigured
     ansible.builtin.file:
       path: /var/www/{{ domain }}/index.html
       state: touch  
     

       
  

